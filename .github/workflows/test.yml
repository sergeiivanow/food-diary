on:
  pull_request:

name: Test

env:
  DIAWI_TOKEN: ${{ secrets.DIAWI_TOKEN }}
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
  CHAT_ID: ${{ secrets.CHAT_ID }}

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install npm packages
        run: yarn install
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '2.7.6'
          bundler-cache: true
      - name: Modify directory permissions
        run: sudo chmod -R 777 /var/lib/gems/3.0.0
      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '11'
      - name: Setup Android SDK
        uses: android-actions/setup-android@v2
      - name: Build android
        run: |
          fastlane android build
      - name: Upload build to Diawi
        run: |
          fastlane android upload_build_to_diawi
      - name: Send a message to Telegram about the crash of the assembly
        if: ${{ failure() }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            –°–±–æ—Ä–∫–∞ –Ω–∞–µ–±—É–Ω–ª–∞—Å—å, —á–µ—Ç ü§∑üèø
            
